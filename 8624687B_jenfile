#!/bin/bash

set -e

# ================================
# Stage: 8624687B_OP_S1 - Backup UAT Web Server
# ================================
echo "================================"
echo "Stage: 8624687B_OP_S1 - Backup UAT Web Server"
echo "================================"

docker commit 8624687b_uatsvr uat_backup:latest || {
    echo "Error: Failed to create a backup image for UAT Web Server."
    exit 1
}
echo "Backup completed."

# ================================
# Stage: 8624687B_OP_S2 - Verify UAT Web Server
# ================================
echo "================================"
echo "Stage: 8624687B_OP_S2 - Verify UAT Web Server"
echo "================================"

curl -s --head http://localhost:32500 | grep "200 OK"
if [ $? -ne 0 ]; then
    echo "Error: UAT Web Server is not running."
    exit 1
fi
echo "UAT Web Server is running."

# ================================
# Stage: 8624687B_OP_S3 - Performing Stress Test
# ================================
echo "================================"
echo "Stage: 8624687B_OP_S3 - Performing Stress Test"
echo "================================"

# Simulated stress test (replace with actual test command)
echo "Running stress test on UAT web server..."
sleep 3
echo "Stress test completed."

# ================================
# Stage: 8624687B_OP_S4 - Stress Test Result
# ================================
echo "================================"
echo "Stage: 8624687B_OP_S4 - Stress Test Result"
echo "================================"
echo "Stress test result is good."

# ================================
# Stage: 8624687B_OP_S5 - Deploy to Production
# ================================
echo "================================"
echo "Stage: 8624687B_OP_S5 - Deploy to Production"
echo "================================"
echo "Proceed to update production web server? (yes/no)"
read answer
if [ "$answer" != "yes" ]; then
    echo "Aborting deployment."
    exit 1
fi

echo "Updating production server..."
docker commit 8624687b_prodsvr prod_backup:latest || {
    echo "Error: Failed to create a backup image for Production Web Server."
    exit 1
}
echo "Production update completed."

# ================================
# Stage: 8624687B_OP_S6 - Verify Production Server
# ================================
echo "================================"
echo "Stage: 8624687B_OP_S6 - Verify Production Server"
echo "================================"

curl -s --head http://localhost:32600 | grep "200 OK"
if [ $? -ne 0 ]; then
    echo "Error: Production Web Server is not running."
    exit 1
fi
echo "Production Web Server is running."

# ================================
# Stage: 8624687B_OP_S7 - Final Verification
# ================================
echo "================================"
echo "Stage: 8624687B_OP_S7 - Final Verification"
echo "================================"

echo "Production website is operational."
exit 0
